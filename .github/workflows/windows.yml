name: Build for Windows

on: [push]


jobs:
  build_windows:
    name: Windows
    runs-on: windows-latest
    steps:
     - name: Checkout repository
       uses: actions/checkout@v1
     - name: Get sha_short
       id: vars
       run: echo "::set-output name=sha_short::$(git rev-parse --short HEAD)"
     - name: Install msys2
       uses: numworks/setup-msys2@v1
     - name: Synchronize package databases
       run: msys2do pacman -Syy --noconfirm
     - name: Install necessary packages
       run: msys2do pacman -S --noconfirm mingw-w64-x86_64-libzip mingw-w64-x86_64-pkg-config mingw-w64-x86_64-dlfcn mingw-w64-x86_64-gcc git make tar unzip xz
     - name: Install plugin dependencies
       run: msys2do pacman -S --noconfirm mingw-w64-x86_64-jansson mingw-w64-x86_64-gtk3 mingw-w64-x86_64-gtk2 mingw-w64-x86_64-mpg123 mingw-w64-x86_64-flac mingw-w64-x86_64-curl mingw-w64-x86_64-portaudio mingw-w64-x86_64-faad2 mingw-w64-x86_64-flac mingw-w64-x86_64-wavpack mingw-w64-x86_64-libvorbis mingw-w64-x86_64-libogg mingw-w64-x86_64-opusfile mingw-w64-x86_64-opus mingw-w64-x86_64-libsndfile mingw-w64-x86_64-libsamplerate
     - name: Prepare theme
       run: msys2do git clone https://github.com/kuba160/Windows-10.git && rm -rv Windows-10/.git
     - name: Prepare icons
       run: msys2do git clone https://github.com/kuba160/Windows-10-Icons.git && rm -rv Windows-10-Icons/.git
     - name: Download premake5
       run: msys2do wget https://github.com/premake/premake-core/releases/download/v5.0.0-alpha14/premake-5.0.0-alpha14-windows.zip && unzip premake-5.0.0-alpha14-windows.zip
     - name: Run premake5
       run: msys2do ./premake5 --os=linux --file=premake5-win.lua --standard gmake
     - name: Build deadbeef
       run: msys2do make config=release_windows
     - name: Build deadbeef with debugging symbols
       run: msys2do make config=debug_windows
     - name: Install theme and icons
       run: msys2do cp -r Windows-10 bin/debug/share/themes ; cp -r Windows-10 bin/release/share/themes ; cp -r Windows-10-Icons bin/debug/share/icons ; cp -r Windows-10-Icons bin/release/share/icons
     - name: Upload artifact windows-${{ steps.vars.outputs.sha_short }}.zip
       uses: actions/upload-artifact@v1
       with:
         name: windows-${{ steps.vars.outputs.sha_short }}
         path: ./bin/release
     - name: Upload artifact windows-debug-${{ steps.vars.outputs.sha_short }}.zip
       uses: actions/upload-artifact@v1
       with:
         name: windows-debug-${{ steps.vars.outputs.sha_short }}
         path: ./bin/debug

